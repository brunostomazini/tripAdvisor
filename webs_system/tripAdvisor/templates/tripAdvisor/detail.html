{% extends "minimal.html"%}

{% block extra_head %}

<!-- Se o seu template minimal.html tiver um bloco "extra_head", você pode injetar estilos ou scripts aqui. -->

<style>
/* Estilo para garantir que as estrelas sejam clicáveis e fiquem amarelas /
.star-rating .star {
cursor: pointer;
color: #6c757d; / Cor cinza padrão /
transition: color 0.2s;
font-size: 1.5rem; / Aumenta o tamanho das estrelas */
}

.star-rating .star.filled {
    color: #ffc107; /* Cor amarela para preenchido (warning) */
}

/* Nota: Usamos cores escuras, então garantir que o fundo do corpo seja escuro */
body {
    /* Garante que o fundo seja preto, se o minimal.html definir outra coisa */
    background-color: #000000; 
}


</style>

{% endblock extra_head %}

{% block menu %}

<!-- ... (O conteúdo do menu vai aqui, assumindo que usa minimal.html) -->

{% endblock menu %}

{% block title %}

<h1 class="display-5 text-warning fw-bold mt-4">Detalhes da Atração</h1>
{% endblock title %}

{% block left %}

<div class="d-none"></div>
{% endblock left %}

{% block right %}

<div class="d-none"></div>
{% endblock right %}

{% block main %}
<a href="javascript:history.back()" class="btn btn-outline-secondary mb-4">
<i class="bi bi-arrow-left me-1"></i> Voltar à Lista
</a>

<div class="card bg-dark text-light border-secondary shadow-lg mb-5">
<div class="card-header bg-secondary">
<h2 class="h4 mb-0">{{ atracao.nome }} <span class="badge bg-warning text-dark">{{ model_name|capfirst }}</span></h2>
</div>

<div class="card-body">
    
    <!-- SEÇÃO DE FOTO E NOTA GERAL -->
    <div class="row mb-4">
        <div class="col-md-5">
            {% if atracao.foto %}
                <img src="{{ atracao.foto.url }}" class="img-fluid rounded shadow-lg" alt="Foto de {{ atracao.nome }}">
            {% else %}
                <div class="bg-dark p-5 rounded shadow-lg text-center border border-warning" style="height: 250px;">
                    <i class="bi bi-image display-4 text-secondary"></i>
                    <p class="text-muted mt-2">Nenhuma imagem carregada.</p>
                </div>
            {% endif %}
        </div>

        <div class="col-md-7 d-flex flex-column justify-content-between">
            <div>
                <!-- DESCRIÇÃO -->
                <p class="card-text mb-4">{{ atracao.descricao|default:"Nenhuma descrição detalhada disponível." }}</p>

                <!-- NOTA GERAL (Assumindo que 'media_notas' é passado no contexto) -->
                <h4 class="text-warning mt-3">
                    Média de Avaliações: 
                    {% if media_notas %}
                        <span class="badge bg-warning text-dark fs-5">{{ media_notas|floatformat:1 }} / 10</span>
                        <small class="text-light">({{ avaliacoes|length }} avaliações)</small>
                    {% else %}
                        <span class="badge bg-secondary text-light fs-5">Sem Nota</span>
                    {% endif %}
                </h4>
            </div>
        </div>
    </div>
    
    <hr class="border-secondary">
    
    <!-- INFORMAÇÕES DETALHADAS -->
    <h5 class="mt-4 text-info">Informações de Contato e Operação:</h5>
    <div class="row">
        <div class="col-md-6">
            <!-- ENDEREÇO E CONTATO -->
            <ul class="list-unstyled">
                <li class="mb-2"><i class="bi bi-geo-alt me-2 text-warning"></i> 
                    Endereço: 
                    {% if atracao.endereco %}
                        {{ atracao.endereco.rua }}, {{ atracao.endereco.cidade }} - {{ atracao.endereco.pais }}
                    {% else %}
                        <span class="text-muted">Não informado</span>
                    {% endif %}
                </li>
                <li class="mb-2"><i class="bi bi-phone me-2 text-warning"></i> 
                    Telefone: 
                    {% if atracao.telefone %}
                        <a href="tel:{{ atracao.telefone }}" class="text-light">{{ atracao.telefone }}</a>
                    {% else %}
                        <span class="text-muted">Não informado</span>
                    {% endif %}
                </li>
                <li class="mb-2"><i class="bi bi-globe me-2 text-warning"></i> 
                    Site: 
                    {% if atracao.site %}
                        <a href="{{ atracao.site }}" target="_blank" class="text-light">{{ atracao.site }}</a>
                    {% else %}
                        <span class="text-muted">Não informado</span>
                    {% endif %}
                </li>
            </ul>
        </div>
        <div class="col-md-6">
            <!-- HORÁRIO E CATEGORIAS -->
            <ul class="list-unstyled">
                <li class="mb-2"><i class="bi bi-clock me-2 text-warning"></i> 
                    Horário de Funcionamento: 
                    {% if atracao.horario_funcionamento %}
                        {{ atracao.horario_funcionamento }}
                    {% else %}
                        <span class="text-muted">Não informado</span>
                    {% endif %}
                </li>
                <li class="mb-2"><i class="bi bi-tag me-2 text-warning"></i> Tipo: {{ atracao.tipo|default:"Não especificado" }}</li>
                <li class="mb-2"><i class="bi bi-bookmark me-2 text-warning"></i> 
                    Categorias: 
                    {% if atracao.categoria.all %}
                        {% for cat in atracao.categoria.all %}
                            <span class="badge bg-dark border border-info text-info">{{ cat.nome }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">Nenhuma</span>
                    {% endif %}
                </li>
            </ul>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top border-secondary">
        {% if perms.tripAdvisor.change_local or perms.tripAdvisor.change_atividade %}
            <a href="{% url 'tripAdvisor:'|add:model_name|add:'_update' pk=atracao.pk %}" class="btn btn-warning btn-sm">
                <i class="bi bi-pencil-square"></i> Editar
            </a>
        {% endif %}
        {% if perms.tripAdvisor.delete_local or perms.tripAdvisor.delete_atividade %}
            <a href="{% url 'tripAdvisor:'|add:model_name|add:'_delete' pk=atracao.pk %}" class="btn btn-danger btn-sm">
                <i class="bi bi-trash"></i> Excluir
            </a>
        {% endif %}
    </div>
</div>


</div>

<!-- SEÇÃO DE AVALIAÇÕES -->

<div class="mt-5">
<h3 class="text-light border-bottom border-secondary pb-2 mb-4">Avaliações ({{ avaliacoes|length }})</h3>

<!-- Formulário de Nova Avaliação -->
<div class="card bg-dark border-info mb-4 shadow-sm">
    <div class="card-header bg-info text-dark fw-bold">
        Adicionar sua Avaliação
    </div>
    <div class="card-body">
        {% if user.is_authenticated %}
            {% if atracao_pk %}
                <form method="post" action="">
                    {% csrf_token %}
                    
                    <!-- Título e Texto (usando widgets com form-control definidos no forms.py) -->
                    <div class="mb-3">
                        {{ avaliacao_form.titulo.label_tag }}
                        {{ avaliacao_form.titulo }}
                        {% if avaliacao_form.titulo.errors %}<div class="text-danger">{{ avaliacao_form.titulo.errors }}</div>{% endif %}
                    </div>

                    <div class="mb-3">
                        {{ avaliacao_form.texto.label_tag }}
                        {{ avaliacao_form.texto }}
                        {% if avaliacao_form.texto.errors %}<div class="text-danger">{{ avaliacao_form.texto.errors }}</div>{% endif %}
                    </div>

                    <!-- Data da Visita -->
                    <div class="mb-3">
                        {{ avaliacao_form.data_visita.label_tag }}
                        {{ avaliacao_form.data_visita }}
                        {% if avaliacao_form.data_visita.errors %}<div class="text-danger">{{ avaliacao_form.data_visita.errors }}</div>{% endif %}
                    </div>

                    <!-- 
                        CORREÇÃO: Implementação da Interface de Estrelas (sem 'choices' no modelo)
                    -->
                    <div class="mb-3">
                        <label for="id_nota" class="form-label">Nota (1 a 10)</label>
                        
                        <!-- O CAMPO REAL DO DJANGO (oculto e manipulado pelo JS) -->
                        {{ avaliacao_form.nota }} 
                        
                        <div class="star-rating d-flex gap-1" id="star-rating-container">
                            {% for i in "1234567890"|make_list %}
                                <!-- O forloop.counter vai de 1 a 10. Usamos a tag i para o ícone de estrela. -->
                                <i class="bi bi-star-fill star" data-value="{{ forloop.counter }}"></i>
                            {% endfor %}
                        </div>
                        
                        <small class="text-muted">Clique em uma estrela para dar uma nota.</small>
                        {% if avaliacao_form.nota.errors %}<div class="text-danger">{{ avaliacao_form.nota.errors }}</div>{% endif %}
                    </div>
                    
                    <button type="submit" class="btn btn-info mt-2"><i class="bi bi-send-fill me-1"></i> Enviar Avaliação</button>
                </form>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const stars = document.querySelectorAll('#star-rating-container .star');
                        const notaInput = document.getElementById('id_nota');
                        const container = document.getElementById('star-rating-container');

                        // Função para preencher as estrelas
                        function fillStars(value) {
                            stars.forEach(star => {
                                const starValue = parseInt(star.getAttribute('data-value'));
                                if (starValue <= value) {
                                    star.classList.add('filled');
                                } else {
                                    star.classList.remove('filled');
                                }
                            });
                        }

                        // 1. Inicializa o estado das estrelas com base no valor inicial do input
                        const initialValue = parseInt(notaInput.value) || 10;
                        fillStars(initialValue);
                        
                        // 2. Adiciona o listener de click
                        container.addEventListener('click', (event) => {
                            let target = event.target;

                            // Verifica se o clique foi em uma estrela (ou seu pai)
                            if (target.classList.contains('star')) {
                                const value = parseInt(target.getAttribute('data-value'));
                                
                                // Atualiza o campo de formulário real
                                notaInput.value = value;
                                
                                // Atualiza a aparência das estrelas
                                fillStars(value);
                            }
                        });

                        // 3. Adiciona o listener de hover (efeito visual)
                        container.addEventListener('mouseover', (event) => {
                            let target = event.target;
                            if (target.classList.contains('star')) {
                                const hoverValue = parseInt(target.getAttribute('data-value'));
                                stars.forEach(star => {
                                    const starValue = parseInt(star.getAttribute('data-value'));
                                    if (starValue <= hoverValue) {
                                        star.classList.add('text-warning');
                                        star.classList.remove('text-secondary');
                                    } else {
                                        star.classList.remove('text-warning');
                                        star.classList.add('text-secondary');
                                    }
                                });
                            }
                        });

                        // 4. Resetar a aparência ao sair do container
                        container.addEventListener('mouseleave', () => {
                            const currentValue = parseInt(notaInput.value) || 0;
                            stars.forEach(star => {
                                const starValue = parseInt(star.getAttribute('data-value'));
                                if (starValue <= currentValue) {
                                    star.classList.add('filled', 'text-warning');
                                    star.classList.remove('text-secondary');
                                } else {
                                    star.classList.remove('filled', 'text-warning');
                                    star.classList.add('text-secondary');
                                }
                            });
                        });
                    });
                </script>

            {% else %}
                <div class="alert alert-danger">Erro: ID da atração não está disponível no contexto.</div>
            {% endif %}
        {% else %}
            <div class="alert alert-warning text-center">
                <i class="bi bi-lock-fill me-2"></i> Você precisa <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">fazer login</a> para deixar uma avaliação.
            </div>
        {% endif %}
    </div>
</div>

<!-- Exibição das Avaliações Existentes -->
{% if avaliacoes %}
    {% for avaliacao in avaliacoes %}
        <div class="card bg-secondary text-light mb-3 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h5 class="card-title text-warning fw-bold mb-1">{{ avaliacao.titulo }}</h5>
                        <h6 class="card-subtitle mb-2">
                            <!-- Loop para exibir estrelas baseadas na nota (0-10) -->
                            {% for i in "1234567890"|make_list %}
                                {% if forloop.counter <= avaliacao.nota %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                            (Nota: {{ avaliacao.nota }}/10)
                        </h6>
                    </div>
                    <small class="text-light text-end">
                        Por: 
                        <a href="" class="text-warning fw-bold text-decoration-none">
                            {{ avaliacao.perfil.nome|default:avaliacao.perfil.user.username }}
                        </a>
                        <br>
                        Em: {{ avaliacao.data_avaliacao|date:"d/m/Y" }}
                    </small>
                </div>
                <p class="card-text">{{ avaliacao.texto }}</p>
                <small class="text-muted">Data da Visita: {{ avaliacao.data_visita|date:"d/m/Y" }}</small>
            </div>
            <div class="card-footer d-flex justify-content-end bg-dark border-secondary">
                <span class="text-info me-3"><i class="bi bi-hand-thumbs-up-fill me-1"></i> {{ avaliacao.likes }} Likes</span>
                <button class="btn btn-sm btn-outline-info disabled" title="Em desenvolvimento">Curtir</button>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="alert alert-light text-center">
        Nenhuma avaliação ainda. Seja o primeiro a avaliar!
    </div>
{% endif %}


</div>
{% endblock main %}